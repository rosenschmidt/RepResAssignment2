================================================================================
# An Analysis of some Weather Data to Determine Economic and Human Costs

#### by Fred Schmidt fred@rosenschmidt.org, July 2014

For coursera Reproducible Data with Roger Peng et. al.
Part of the Data Science sequence of courses.

================================================================================

## Synopsis

TO DO
 - [done] synopsis
 - [done] uli zellbeck grepl improvements
 - footnote to same
 - footnotes in Rmd?
 - vastly shorten the data cleanup section
 - [done] try a tertiary, quaternary heading
 - [done] why doesn't !file.exists work for me?
 - histogram bars - don't have control over them
 - scaling of graphs
 - conclusions
 - summary

This is a short analysis of data from NOAA weather storm database,
specifically the National Climactic Data Center Storm Events, at
[NOAA](www.ncdc.noaa.gov/stormevents/details.jsp).
More detailed documentation of the database is provided on that site,
[documentation]( http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf) in
**.pdf** format. As described below, the data provided for this course assignment
appears to have been massaged somewhat and may perhaps be different than
what one might download directly from that site. The data cover the period
January 3 1950, through November 30, 2011.


The goal of the analysis is to measure, in a simple way, the economic and human
costs of various weather events, as defined in dollar estimates, and 
injuries and fatalities. Similar studies (e.g. submissions by other students
in this class) may come to starkly different results, because of how the
weather events are grouped - due to problems in the data, we must decide
which weather events are "the same" in some sense.

This analysis and its data are posted on my github site,
[rosenschmidt](https://github.com/rosenschmidt/RepResAssignment2)
along with the actual data used and, by the time you are reading this,
perhaps some additional ancillary material.

This analysis is somewhat over-documented, as it will be a record  to myself
of how to do certain things.

================================================================================

## Data Processing

### Data Sources

That particular [NOAA](www.ncdc.noaa.gov/stormevents/details.jsp) web site
gave me a hint of the troubles to come. As these troubles came to light, 
I attempted my own download of the data, but I did not see any way to easily
replicate the download (all years in one file). Furthermore, a cursory inspection
of the data revealed that it did not *seem* to have the problems in the file
provided for the course. *Therefore*, I used the data file provided on the
course website.

In particular, that the database allows 48 different types of weather event,
yet the dataset we are given for the class has nearly a thousand! That led to 
the next dillemma. For the course, we are given a complete file,
[datasite](http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)
where all the years from 1950 through 2011. There are other questionable
features of this dataset, which I won't go into,
and if the scope of the assignment allowed,
I would add a section to this analysis replicating the production of the data file
from the NOAA website. As I've mentioned, however, that does not look
straightforward, so we leave that as an exercise for the reader.

### The Computing Environment I Used

We use the command provided within **R** to show the environment:
```{r showsetup}
sessionInfo()
```
which shows certain relevant information, except Windows 7 and an Intel
motherboard and CPU.
Afaik this confirms that I am running the 64-bit version of R.

This file was tested and run first in Rgui,
 and only the final run and submission were in Rstudio.


### Unzipping and Reading the Data


TO DO: unzip the data successfully (so far no luck). But for whatever reason,
on *MY* system, I can read the .bz2 file directly. 

For posterity's sake, I've checked in to this github repository.

```{r getdata, cache=TRUE}
# We use the cache=TRUE Rmd option, since this is the slowest part

if(!file.exists("repdata-data-StormData.csv.bz2"))
     {
        # I had to change https to http in the URL from the web site,
        # to make this work on my system.
        URL <- "http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
        download.file(URL,"repdata-data-StormData.csv.bz2")
     }
```

Here is some text between getting and reading.


```{r readdata, cache=TRUE}

# Because I don't need to on my system, I save the unzip:
# bunzip2("repdata-data-stormData.csv.bz2")

main_data <- read.table("repdata-data-StormData.csv.bz2",
                         sep=",",
                         header=TRUE,
                         strip.white=TRUE)

```

Note that I've already begun the data cleaning: namely, the option
**strip.white=TRUE**. That's because, in this data set, there are event types
that differ only in leading or trailing white space.

================================================================================


### A Further Note on Processing the Data - PROBLEMS WITH EVENT TYPES!

The strip.white=TRUE begins the process of cleaning the EVTYPE variable.
According to the [documentation](www.ncdc.noaa.gov/stormevents/details.jsp),
 there are 48 allowed 
event types. And yet casual inspection of the data set shows a lot! And we have
already stripped white space in the read.table above, because visual inspection
showed EVTYPES such as "WIND", " WIND", "   WIND     ", etc.

Since we got rid of white space, let's get rid of all the upper and lower case
combinatorics, which eliminates about 100 of the 1000, or 10%:

```{r cleanevents, cache=TRUE}
main_data$EVTYPE <- toupper(main_data$EVTYPE)
# when we use toupper, it converts it to char from factor so we put that back
main_data$EVTYPE <- as.factor(main_data$EVTYPE)

event_types  <- with(main_data,table(EVTYPE))

# I cannot make heads nor tails of how to print this neatly, but if I do
event_types <- as.data.frame(event_types)
# Now, printing y to the terminal ( i.e. "> y <CR> " ) would give me
# a nice columnar output. 
head(event_types,n=20)

```

*There are `r nrow(event_types)` values in the EVTYPE field of this data set.
Even though the documentation specifies 48 allowed EVTYPEs.*
And this is *after* stripping white space and converting all characters to the
same case.

Of these `r nrow(event_types)` values, a simple visual inspection shows that many
are variants, and a little work with grepl to replace like terms with 
exactly the same term will quickly yield a better analysis.

### An Executive Decision: COMBINE EVENT TYPES

It would be nice to use grep and so forth to combine all disallowed
types into allowed types, without combinbing allowed types, but that gets messy.

Therefore, even if it means **combining allowed values**, I will combine event types.
I will do this for two reasons. First, for example, what is the difference
between Blizzard, Heavy Snow, Winter Storm, and Winter Weather?
Plus, one could argue that misclassification among **allowed types**
disguises the economic and health costs of certain events.

So as to make the analysis more reproducible, I will combine them into 
my own added variable. As we recall from the prior classes, we can add a column
to a data frame merly by naming it. We'll do this to event_types first
to see how it looks.

NOTE that the way that I do this, order *might* matter, in that for example
I am only filling in the EDITED field if it was not previously filled in.
Thus words like WIND, RAIN, etc which might appear multiply in descriptions,
are sort of picked out in the order that I manually determined as I did these
sequentially. Your mileage may vary. (However, as we find below, the results
are so clear that for this level of analysis, it doesn't matter that much
how we group them, as long as our grouping is sensible.)

```{r combineevents, cache=TRUE}

# create an empty additional variable
event_types$EDITED <- rep("",length(event_types$EVTYPE))

# Volcano action is pretty unique
list1 <- c("VOLCAN")
event_types$EDITED[grepl(paste(list1,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "VOLCANIC ASH"

# Tornado is also pretty specific
list2 <- c("TORNADO","WATERSPOUT","FUNNEL","TORNDAO")
event_types$EDITED[grepl(paste(list2,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "TORNADO"

# anything with dust seems to be its own deal
list3 <- c("DUST")
event_types$EDITED[grepl(paste(list3,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "DUST"

# do events with "FLOOD" in them BEFORE other rain/snow/ice events
list4 <- c("FLOOD")
event_types$EDITED[grepl(paste(list4,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "FLOOD"

# keep FROST separate (crop damage)
list5 <- c("FROST")
event_types$EDITED[grepl(paste(list5,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "FROST"

# hail is its own deal (crop damage)
list6 <- c("HAIL")
event_types$EDITED[grepl(paste(list6,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "HAIL"

# put all ICE events together
list7 <- c( "FREEZING", "SLEET", "ICE", "ICY","FREEZE","GLAZE")
event_types$EDITED[grepl(paste(list7,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "SLEET"

# combine the REST of WINTER (non-ICE) events
list8 <- c("WINTER", "WINTRY", "BLIZZARD", "THUNDERSNOW")

event_types$EDITED[grepl(paste(list8,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "WINTER"

# COLD
list9 <- c("COLD","CHILL")
event_types$EDITED[grepl(paste(list9,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "COLD"

# HEAT
list10 <- c("HEAT","HOT")
event_types$EDITED[grepl(paste(list10,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "HEAT"


# Thunderstorms
list11 <- c( "TSTM WIND", "THUNDERSTORM", "THUNDER", "TUNDER",
             "THUNDEER", "THUDER", "STORM WIND")

event_types$EDITED[grepl(paste(list11,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "THUNDERSTORM WIND"

# lightning
list12 <- c("LIGHTNING")
event_types$EDITED[grepl(paste(list12,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "LIGHTNING"

# at this point, everything left with snow is also winter
list13 <- c("SNOW")
event_types$EDITED[grepl(paste(list13,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "WINTER"

# TROPICAL STORMS, etc
list14 <- c("TROPICAL", "MARINE", "TSUNAMI", "TYPHOON",
            "HURRICANE", "SURGE", "SURF")

event_types$EDITED[grepl(paste(list14,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "TROPICAL"

# OTHER RAIN - anything left that has the word RAIN
list15 <- c("RAIN")
event_types$EDITED[grepl(paste(list15,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "HEAVY RAIN"

# let's START picking off wind, of which there's a lot
list16 <- c( "HIGH WIND", "MICROBURST", "MICOBURST")

event_types$EDITED[grepl(paste(list16,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "HIGH WIND"

# FIRE
list17 <- c("FIRE", "SMOKE")
event_types$EDITED[grepl(paste(list17,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "WILDFIRE"


# at this point, everything left with WIND is high wind imho
list18 <- c("WIND")
event_types$EDITED[grepl(paste(list18,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "HIGH WIND"

# There are a LOT of events from 1996 called "summary"
# although we have no idea what they mean, let's lump them together
list19 <- c("SUMMARY")
event_types$EDITED[grepl(paste(list19,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "SUMMARY in 1996"

# all the warm left,at this point, means heat
list20 <- c("WARM")
event_types$EDITED[grepl(paste(list20,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "HEAT"

# drought
list21 <- c("DROUGHT", "DRY")
event_types$EDITED[grepl(paste(list21,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "DROUGHT"

# rip tides will have fatalities, and there are about 400 of each spelling
list22 <- c("RIP")
event_types$EDITED[grepl(paste(list22,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "RIP CURRENT"


# remaining urbans are flood
list23 <- c("URBAN")
event_types$EDITED[grepl(paste(list23,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "FLOOD"

# earth movements
list24 <- c("LANDSLIDE", "AVA", "ROCK", "MUD")

event_types$EDITED[grepl(paste(list24,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "AVALANCHE"

# FOG
list25 <- c("FOG")
event_types$EDITED[grepl(paste(list25,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "DENSE FOG"

# GUSTS that aren't something else
list26 <- c("GUST")
event_types$EDITED[grepl(paste(list26,collapse="|"),event_types$EVTYPE) &
                   (event_types$EDITED == "")] <- "HIGH WIND"


# edited_event_types  <- with(event_types,table(EDITED))
# edited_event_types <- as.data.frame(edited_event_types)

```

Now we display a smaller, stylized group of event types to work with.
The frequency of my combined/corrected events is as follows.

```{r summaryeditedevents,cache=TRUE}
rowsum(event_types$Freq,event_types$EDITED)
```
This shows our expected total of
 `r sum(rowsum(event_types$Freq,event_types$EDITED))`, as expected.
It leaves only sum(event_types[event_types$EDITED=="","Freq"]) unexplained,
which we'll argue is negligible.

================================================================================

## RESULTS

We now map our stylized, simplified set of events to the main data set.

```{r results1, cache=TRUE}
main_data <- merge(main_data,event_types,by="EVTYPE")
event_types2  <- with(main_data,table(EDITED))
event_types2 <- as.data.frame(event_types2)

```

Now we do the actual work of the assignment: assigning fatalities, injuries,
and economic damage to these stylized types.

We first make some heroic assumptions about PROPDMGEXP being an exponent on
the dollars in PROPDMG; ditto for crop damage. The vast majority of these
...EXP fields are empty. As before, we are cautious and create a new edited
field and work on that, so we can compare results. Inspection of the exponents
shows we have nothing, +,-,?,and positive integers 0-9. 
```{r showexponents,cache=TRUE}
as.data.frame(with(main_data,table(PROPDMGEXP)))
as.data.frame(with(main_data,table(CROPDMGEXP)))
```

Nevertheless, we plunge ahead.

```{r exponents,cache=TRUE}

main_data$PD_EXPONENT <- as.character(main_data$PROPDMGEXP)
main_data$PD_EXPONENT[main_data$PD_EXPONENT==""] <- 0
main_data$PD_EXPONENT[grepl("\\+|\\-|\\?",main_data$PD_EXPONENT)] <- 0 # ignore
main_data$PD_EXPONENT[grepl("h|H",main_data$PD_EXPONENT)] <- 2 # hundreds
main_data$PD_EXPONENT[grepl("k|K",main_data$PD_EXPONENT)] <- 3 # thousands
main_data$PD_EXPONENT[grepl("m|M",main_data$PD_EXPONENT)] <- 6 # millions
main_data$PD_EXPONENT[grepl("b|B",main_data$PD_EXPONENT)] <- 9 # billions
main_data$PD_EXPONENT <- as.numeric(main_data$PD_EXPONENT)

main_data$CD_EXPONENT <- as.character(main_data$CROPDMGEXP)
main_data$CD_EXPONENT[main_data$CD_EXPONENT==""] <- 0
main_data$CD_EXPONENT[grepl("\\+|\\-|\\?",main_data$CD_EXPONENT)] <- 0 # ignore
main_data$CD_EXPONENT[grepl("h|H",main_data$CD_EXPONENT)] <- 2 # hundreds
main_data$CD_EXPONENT[grepl("k|K",main_data$CD_EXPONENT)] <- 3 # thousands
main_data$CD_EXPONENT[grepl("m|M",main_data$CD_EXPONENT)] <- 6 # millions
main_data$CD_EXPONENT[grepl("b|B",main_data$CD_EXPONENT)] <- 9 # billions
main_data$CD_EXPONENT <- as.numeric(main_data$CD_EXPONENT)

main_data$PROP_DAMAGE <- main_data$PROPDMG * 10^main_data$PD_EXPONENT
main_data$CROP_DAMAGE <- main_data$CROPDMG * 10^main_data$CD_EXPONENT

```

================================================================================

## CONCLUSIONS

```{r results,cache=TRUE}

prop_damage <- aggregate(main_data$PROP_DAMAGE,by=list(main_data$EDITED),sum)
colnames(prop_damage) <- c("EVENT","TOTAL")
crop_damage <- aggregate(main_data$CROP_DAMAGE,by=list(main_data$EDITED),sum)
colnames(crop_damage) <- c("EVENT","TOTAL")
fatalities  <- aggregate(main_data$FATALITIES,by=list(main_data$EDITED),sum)
colnames(fatalities) <- c("EVENT","TOTAL")
injuries  <- aggregate(main_data$INJURIES,by=list(main_data$EDITED),sum)
colnames(injuries) <- c("EVENT","TOTAL")

prop_damage$EVENT <- as.factor(prop_damage$EVENT)
crop_damage$EVENT <- as.factor(crop_damage$EVENT)
fatalities$EVENT <- as.factor(fatalities$EVENT)
injuries$EVENT <- as.factor(injuries$EVENT)

```

```{r results2,fig.height=20,fig.width=20,cache=TRUE}

par(mfrow=c(2,1),mar=c(10,5,2.5,1),las=2)
plot(prop_damage$EVENT,log10(prop_damage$TOTAL),
     las=2,
     type="h",
     ylab="log base 10 of total property damage",
     main="Property Damage")
plot(crop_damage$EVENT,log10(crop_damage$TOTAL),
     las=2,
     type="h",
     ylab="log base 10 of total crop damage",
     main="Crop Damage")
```

```{r results3,fig.height=20,fig.width=20,cache=TRUE}

par(mfrow=c(2,1),mar=c(10,5,2.5,1),las=2)
plot(fatalities$EVENT,log10(fatalities$TOTAL),
     las=2,
     type="h",
     ylab="log base 10 of total fatalities",
     main="Fatalities")
plot(injuries$EVENT,log10(injuries$TOTAL),
     las=2,
     type="h",
     ylab="log base 10 of total injuries",
     main="Injuries")
```


================================================================================

## SUMMARY


================================================================================

## scratch pad of stuff remove for final version

```{r delete_me}
# z <- main_data$BGN_DATE[grepl("summary",main_data$EVTYPE,ignore.case=TRUE)]

# z
```

================================================================================
